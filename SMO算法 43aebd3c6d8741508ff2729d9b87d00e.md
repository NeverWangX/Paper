# SMO算法

# 优化目标

$$
\begin{split}    \mathop{min}\limits_{\vec{\alpha}} \Psi(\vec{\alpha}) = \begin{cases}        \underbrace{ min }_{\alpha}  \frac{1}{2} \sum\limits_{i=1}^{N} \sum\limits_{j=1}^{N} \alpha_i\alpha_jy_iy_jK(x_i,x_j) - \sum\limits_{i=1}^{N}\alpha_i\\        s.t. \; \sum\limits_{i=1}^{N}\alpha_iy_i = 0 \\        0 \le \alpha_i \le C    \end{cases}\end{split}
$$

# 迭代公式

## $\alpha_2$ 迭代公式

$$
\alpha_2^{new,unc}=\alpha_2^{old}+\frac{y_2(E_1-E_2)}{\eta}
$$

其中

$$
E_i=f(x_i)-y_i \\\eta=K_{11}+K_{22}-2K_{12}
$$

当 $y_1\neq y_2$ 时：

$$
L=\mathop{max}(0,\alpha_2^{old}-\alpha_1^{old}); \quad H=\mathop{min}(C,C+\alpha_2^{old}-\alpha_1^{old})
$$

当 $y_1=y_2$ 时：

$$
L=\mathop{max}(0,\alpha_1^{old}+\alpha_2^{old}-C);\quad H=\mathop{min}(C,\alpha_2^{old}+\alpha_1^{old})
$$

最终，$\alpha_2$ 的迭代公式如下：

$$
\alpha_2^{new}=\begin{cases}
H, &\alpha_2^{new,unc}>H\\
\alpha_2^{new,unc},&L\leq\alpha_2^{new,unc}\leq H\\
L,&\alpha_2^{new,unc}<L
 \end{cases}
$$

## 求解 $\alpha_1^{new}$

$$
\alpha_1^{new}=\alpha_1^{old}+y_1y_2(\alpha_2^{old}-\alpha_2^{new})
$$

# SMO变量选取

## 第一个变量的选取

第一个变量的选择称为外循环，首先遍历整个样本然后选择违反 KKT 条件的 $\alpha_i$ 作为第一个变量，其 KKT 条件如下：

$$
\begin{split}\alpha_i=0\Rightarrow y_i(w^Tx_i+b)\geq1\\
\alpha_i = C \Rightarrow y_i(w^Tx_i+b)\leq 1\\
0<\alpha_i<C\Rightarrow y_i(w^Tx_i+b)=1\end{split}
$$

一般而言，首选选择违反 $0<\alpha_i<C\Rightarrow y_i(w^Tx_i+b)=1$ 这个条件的点。

如果支持向量都满足 KKT 条件，再选择 $\alpha_i=0\Rightarrow y_i(w^Tx_i+b)\geq1$ 和 $\alpha_i = C \Rightarrow y_i(w^Tx_i+b)\leq 1$ 这两个条件点。

## 第二个变量的选取

第二个变量选择的过程为内循环，选择 $|E_1-E_2|$ 取得最大的 $\alpha_2$ 。

如果内循环中找不到点能够使目标函数有足够的下降，则可遍历支持向量来做 $\alpha_2$ 。

如果所有支持向量均不能使得目标函数有足够的下降，则跳出循环，重新选择 $\alpha_1$ 。

# SMO阈值 $b$ 的计算

1. 若 $0<\alpha_1^{new} < C$ ，则：

$$
b^{new}=b_1^{new}=-E_1-y_1K_{11}(\alpha_1^{new}-\alpha_1^{old})-y_2K_{21}(\alpha_2^{new}-\alpha_2^{old})+b^{old}
$$

1. 若 $0<\alpha_2^{new} < C$ ，则：

$$
b^{new}=b_2^{new}=-E_2-y_1K_{12}(\alpha_1^{new}-\alpha_1^{old})-y_2K_{22}(\alpha_2^{new}-\alpha_2^{old})+b^{old}
$$

1. 若同时满足 $0<\alpha_i^{new} < C$ ，则：

$$
b^{new}=b_1^{new}=b_2^{new}
$$

1. 若同时不满足 $0<\alpha_i^{new} < C$ ，则：

$$
b^{new}=\frac{b_1^{new} + b_2^{new}}{2}
$$

# 求解步骤

1. 取初值 $\alpha = 0$ 和 $t=0$
2. 选择变量 $\alpha_1^t$ 和 $\alpha_2^t$ ，根据公式求解出 $\alpha_2^{t+1}$
3. 利用 $\alpha_1^{t+1}$ 和 $\alpha_1^t$ ，$\alpha_2^t$ ，$\alpha_2^{t+1}$ 的关系求解出 $\alpha_1^{t+1}$ 
4. 通过 $\alpha_1^{t+1}$ 和 $\alpha_2^{t+1}$ 的满足的 KKT 条件关系求出 $b^{t+1}$ 
5. 检查 $E_i$ 是否在允许的精度 $e$ 之内
6. 检查求出的 $\alpha_1^{t+1}$ 和 $\alpha_2^{t+1}$ 是否满足 KKT 条件
7. 如果上面两个条件都满足则返回 $\alpha_1^{t+1}$ 和 $\alpha_2^{t+1}$ ，否则跳转到第 2 步

# 参考资料

[SMO 算法超详细解析](http://blog.sudoyc.com/2019/04/10/ml-svm-smo/)



